<!DOCTYPE html>




<html class="no-js" lang="en">

<head>
  <meta charset="UTF-8">

  


  
  <title>How to use LLVM API with Swift - Low Level Bits ðŸ‡ºðŸ‡¦</title>
  

  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  
  <meta name="keywords" content="llvm ,swift ,interpreter ,jit ,mcjit ,llvm jit ,llvm tutorial ,swift tutorial ,tutorial" />
  

  
  <meta name="description" content="The article shows how to use LLVM C API with Swift." />
  

  <link rel="shortcut icon" href="/favicon.png" type="image/x-icon" />

  
  <link href='https://fonts.googleapis.com/css?family=Open+Sans:400,300' rel='stylesheet' type='text/css'>

  
  
  <link href="https://lowlevelbits.org/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://lowlevelbits.org/css/bootstrap-responsive.min.css" rel="stylesheet">
  <link href="https://lowlevelbits.org/css/socialicons.css" rel="stylesheet">
  <link href="https://lowlevelbits.org/css/template.css" rel="stylesheet">
  
  <link href="https://lowlevelbits.org/css/colors/color-nytimes.css" rel="stylesheet" id="colorcss">

  
  <script src="https://lowlevelbits.org/js/modernizr.js"></script>

  
  <script defer src='https://static.cloudflareinsights.com/beacon.min.js'
    data-cf-beacon='{"token": "b911a163ce714374a123a7d59d6c1342"}'></script>

  
  

  
<meta name="twitter:card" content="summary" />
<meta name="twitter:site" content="@1101_debian" />
<meta name="twitter:title" content="How to use LLVM API with Swift" />
<meta name="twitter:description" content="The article shows how to use LLVM C API with Swift." />

<meta name="twitter:image" content="https://lowlevelbits.org/img/low_level_bits_logo.png" />



  <script id="mcjs">!function(c,h,i,m,p){m=c.createElement(h),p=c.getElementsByTagName(h)[0],m.async=1,m.src=i,p.parentNode.insertBefore(m,p)}(document,"script","https://chimpstatic.com/mcjs-connected/js/users/aaa39cd123ecae87821d0d66a/cc68a3d3a46158689b68653cc.js");</script>

  <script defer data-domain="lowlevelbits.org" src="https://plausible.io/js/plausible.js"></script>
  <script>window.plausible = window.plausible || function () { (window.plausible.q = window.plausible.q || []).push(arguments) }</script>

  <link rel="canonical" href="https://lowlevelbits.org/how-to-use-llvm-api-with-swift/" />

</head>

<body>

  <div class="container">

    <div class="masthead clearfix">

  

  <div>
    <a href="/"><img id="logo" src="https://lowlevelbits.org/img/lowlevelbits.png" alt="Low Level Bits">
    </a>
    <ul id="nav" class="nav ww-nav pull-right hidden-phone">
      <li><a href="https://lowlevelbits.org/about">About</a></li>
    </ul>
  </div>

</div>

    <hr>

    <div class="row main-content">
      <div class="offset3 span7 zone-content">
        <article>
          <h1>How to use LLVM API with Swift</h1>
          <div>
            <p class="post-page-date">
              <i>Published on <time datetime="2015-11-30 12:00:00 &#43;0000 &#43;0000" pubdate>Nov 30, 2015</time></i>
            </p>
          </div>

          <div>
            <p>This article shows how to use LLVM C API with Swift. It doesnâ€™t aim to show how to write proper idiomatic Swift. Besides that I omit some good practices for sake of simplicity.</p>
<p>Our plan for today:</p>
<ul>
<li>grab latest version of LLVM</li>
<li>build it using CMake and llvm-config</li>
<li>create simple Swift program (~50 LoC), build and link it against LLVM</li>
<li>create simple <code>sum</code> function in memory and execute it using LLVM interpreter</li>
</ul>
<p>So, letâ€™s go to town!</p>
<p><strong>UPD:</strong> There is a second part of the article. It shows how to actually use JIT engine: <a href="http://lowlevelbits.org/how-to-use-llvm-api-with-swift-addendum">http://lowlevelbits.org/how-to-use-llvm-api-with-swift-addendum</a></p>
<h3 id="preparing-llvm">Preparing LLVM</h3>
<p>Letâ€™s grab fresh version of LLVM. It can be done using central SVN repository, or via official git mirror. I prefer latter option, since itâ€™s, imho, a bit faster.</p>
<p>For this particular example I will put everything into a directory inside of the home directory:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~ $ mkdir swift_llvm
</span></span><span style="display:flex;"><span>~ $ cd swift_llvm
</span></span><span style="display:flex;"><span>~/swift_llvm $ git clone http://llvm.org/git/llvm.git
</span></span></code></pre></div><p>LLVM uses CMake as a build system. To make a build letâ€™s create a separate directory near LLVM directory and generate build rules:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ mkdir build
</span></span><span style="display:flex;"><span>~/swift_llvm $ cd build
</span></span><span style="display:flex;"><span>~/swift_llvm/build $ cmake  ../llvm
</span></span></code></pre></div><p>CMake could generate various output: makefiles, Xcode projects, VisualStudio solutions and more. If build system is not specified (like in the script above), then CMake takes default one, which is GNU/Make.</p>
<p>Modularity is one of the significant advantages of LLVM. It has dozens of &lsquo;small&rsquo; libraries. We will need to link our program against some of them. If youâ€™re like me and not an LLVM expert, then you probably donâ€™t know which ones you need.</p>
<p>The naive way of solving this problem is to build the program and resolve linker errors manually until they disappear. It will work, indeed, but itâ€™s became boring after resolving 5-6 errors.</p>
<p>Thank god, LLVM developers are thoughtful and provide a great tool <code>llvm-config</code>. Letâ€™s build it and see what it does.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm/build $ make llvm-config -j4
</span></span></code></pre></div><p><em>Note: <code>-j4</code> says &lsquo;I have multi core/processor environment, run 4 jobs simultaneously&rsquo;</em></p>
<p><code>llvm-config</code> provides different options/shortcuts, e.g.: where to look for built libraries, where to look for headers, which linker flags to pass to link in JIT module or interpreter, and so on.</p>
<p><em>Note: Run <code>llvm-config</code> without options to learn more.</em></p>
<p>Weâ€™re particularly interested in interpreter. Letâ€™s look what we need to build:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm/build $ ./bin/llvm-config --libs interpreter
</span></span><span style="display:flex;"><span>-lLLVMInterpreter -lLLVMExecutionEngine -lLLVMRuntimeDyld -lLLVMObject -lLLVMMCParser -lLLVMCodeGen -lLLVMTarget -lLLVMScalarOpts -lLLVMInstCombine -lLLVMInstrumentation -lLLVMTransformUtils -lLLVMMC -lLLVMBitWriter -lLLVMBitReader -lLLVMAnalysis -lLLVMCore -lLLVMSupport
</span></span></code></pre></div><p>To make our little program working we need to build all these libraries. Again, there is naive way of doing this, but we will go with shell magic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm/build $ ./bin/llvm-config --libs interpreter | sed <span style="color:#e6db74">&#34;s/-l//g&#34;</span> | xargs make -j4
</span></span></code></pre></div><h3 id="hello-llvm">Hello LLVM</h3>
<p>Since we have done and have everything in place itâ€™s time to create our little Swift program:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm/build $ cd ..
</span></span><span style="display:flex;"><span>~/swift_llvm $ touch hello_llvm.swift
</span></span><span style="display:flex;"><span>~/swift_llvm $ open hello_llvm.swift
</span></span></code></pre></div><p>To check that everything is working as we expect we will first create an empty module and dump it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">LLVM_C</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> module = LLVMModuleCreateWithName(<span style="color:#e6db74">&#34;Hello&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LLVMDumpModule(module)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LLVMDisposeModule(module)
</span></span></code></pre></div><p>Building this small program requires passing numerous flags to compiler. We need to specify SDK, to set which module to link with, specify linker flags, set correct header search paths and probably provide some additional arguments:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ xcrun -sdk macosx swiftc hello_llvm.swift -module-link-name LLVM_C -L??? -lLLVM??? -I??? ???
</span></span></code></pre></div><p>So many questions, so much magic.</p>
<p>In fact specifying correct linker flags and libraries path is easy, thanks <code>llvm-config</code>:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ xcrun -sdk macosx swiftc hello_llvm.swift -module-link-name LLVM_C <span style="color:#e6db74">`</span>./build/bin/llvm-config --libs interpreter<span style="color:#e6db74">`</span> -L ./build/lib -I??? ???
</span></span></code></pre></div><p>Situation with headers and additional parameters is a bit more trickier. Normally, if we use clang, we could just rely on <code>llvm-config --cflags</code>, though it does not work with swift compiler. Letâ€™s examine the <code>--cflags</code> and see what we can do here:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ ./build/bin/llvm-config --cflags
</span></span><span style="display:flex;"><span>-I/Users/alexdenisov/swift_llvm/llvm/include -I/Users/alexdenisov/swift_llvm/build/include  -fPIC -Wall -W -Wno-unused-parameter -Wwrite-strings -Wmissing-field-initializers -pedantic -Wno-long-long -Wcovered-switch-default -D__STDC_CONSTANT_MACROS -D__STDC_FORMAT_MACROS -D__STDC_LIMIT_MACROS
</span></span></code></pre></div><p>The output contains a few parameters, we can easily omit all arguments except of headers search paths (<code>-I ...</code>) and macro definitions (<code>-D__...</code>). The problem is that swift compiler does not handle macro definitions the way as clang does, though we could bypass them directly to clang driver using <code>-Xcc</code> option:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ xcrun -sdk macosx swiftc hello_llvm.swift -module-link-name LLVM_C <span style="color:#e6db74">`</span>./build/bin/llvm-config --libs interpreter<span style="color:#e6db74">`</span> -L ./build/lib -I ./llvm/include -I ./build/include -Xcc -D__STDC_CONSTANT_MACROS -Xcc -D__STDC_LIMIT_MACROS -Xcc -D__STDC_FORMAT_MACROS
</span></span></code></pre></div><p>If you were eager enough and run the recent command, then you might see some errors: linker complains because it canâ€™t find symbols from ncurses and STD C++ libraries. No worries, here is the correct command:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ xcrun -sdk macosx swiftc hello_llvm.swift -module-link-name LLVM_C <span style="color:#e6db74">`</span>./build/bin/llvm-config --libs interpreter<span style="color:#e6db74">`</span> -L ./build/lib -lc++ -lcurses -I ./llvm/include -I ./build/include -Xcc -D__STDC_CONSTANT_MACROS -Xcc -D__STDC_LIMIT_MACROS -Xcc -D__STDC_FORMAT_MACROS
</span></span></code></pre></div><p>Now we can run the program and see the beautiful LLVM IR:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ ./hello_llvm
</span></span><span style="display:flex;"><span>; ModuleID <span style="color:#f92672">=</span> <span style="color:#e6db74">&#39;Hello&#39;</span>
</span></span></code></pre></div><p>Ok, itâ€™s empty and doesnâ€™t look cool. But there are good newsÂ­: we are able to use LLVM C API from Swift. Isnâ€™t this impressive?</p>
<p>Letâ€™s go further and create simple <code>sum</code> function that accepts two integers, sums them and returns result. Here is a C equivalent:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-c" data-lang="c"><span style="display:flex;"><span><span style="color:#66d9ef">int</span> <span style="color:#a6e22e">sum</span>(<span style="color:#66d9ef">int</span> a, <span style="color:#66d9ef">int</span> b) {
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">return</span> a <span style="color:#f92672">+</span> b;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>To create a function we need to specify all types involved: return type and types of arguments.</p>
<p>Types of arguments must be passed as an array. Since we interop with C API itâ€™s a bit tricky, but still pretty straightforward:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">LLVM_C</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> module = LLVMModuleCreateWithName(<span style="color:#e6db74">&#34;Hello&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> int32 = LLVMInt32Type()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> paramTypes = [int32, int32]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// need to convert paramTypes into UnsafeMutablePointer because of API requirements</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> paramTypesRef = UnsafeMutablePointer&lt;LLVMTypeRef&gt;.alloc(paramTypes.count)
</span></span><span style="display:flex;"><span>paramTypesRef.initializeFrom(paramTypes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> returnType = int32
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> functionType = LLVMFunctionType(returnType, paramTypesRef, UInt32(paramTypes.count), <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> sumFunction = LLVMAddFunction(module, <span style="color:#e6db74">&#34;sum&#34;</span>, functionType)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LLVMDumpModule(module)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>paramTypesRef.dealloc(paramTypes.count)
</span></span><span style="display:flex;"><span>LLVMDisposeModule(module)
</span></span></code></pre></div><p>Build it:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>~/swift_llvm $ xcrun -sdk macosx swiftc hello_llvm.swift -module-link-name LLVM_C <span style="color:#e6db74">`</span>./build/bin/llvm-config --libs interpreter<span style="color:#e6db74">`</span> -L ./build/lib -lc++ -lcurses -I ./llvm/include -I ./build/include -Xcc -D__STDC_CONSTANT_MACROS -Xcc -D__STDC_LIMIT_MACROS -Xcc -D__STDC_FORMAT_MACROS
</span></span></code></pre></div><p>And run:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-llvm" data-lang="llvm"><span style="display:flex;"><span><span style="color:#75715e">; ModuleID = &#39;Hello&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">declare</span> <span style="color:#66d9ef">i32</span> @sum(<span style="color:#66d9ef">i32</span>, <span style="color:#66d9ef">i32</span>)
</span></span></code></pre></div><p>Here you go, function prototype is ready - next step is function body.</p>
<p>Atomic particle of code is a <code>basic block</code>. Function or loop body, conditional branch (<code>if/else</code>, <code>switch/case</code>, etc.) these are basic blocks. Our simple function has one as well:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> entryBlock = LLVMAppendBasicBlock(sumFunction, <span style="color:#e6db74">&#34;entry&#34;</span>)
</span></span></code></pre></div><p>This block could be filled in using builder. First we emit instructions to access function arguments. Next one - addition of the arguments with the <code>temp</code> variable holding the result. And the last instruction - return statement.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> builder = LLVMCreateBuilder()
</span></span><span style="display:flex;"><span>LLVMPositionBuilderAtEnd(builder, entryBlock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> a = LLVMGetParam(sumFunction, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> b = LLVMGetParam(sumFunction, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> temp = LLVMBuildAdd(builder, a, b, <span style="color:#e6db74">&#34;temp&#34;</span>)
</span></span><span style="display:flex;"><span>LLVMBuildRet(builder, temp)
</span></span></code></pre></div><p><em>Put this code after <code>sumFunction</code> declaration, but before <code>LLVMDumpModule</code>. Or just keep reading, you will see the full code listing at the end of the article.</em></p>
<p>Build and run, you will see the function body:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-llvm" data-lang="llvm"><span style="display:flex;"><span><span style="color:#75715e">; ModuleID = &#39;Hello&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">define</span> <span style="color:#66d9ef">i32</span> @sum(<span style="color:#66d9ef">i32</span>, <span style="color:#66d9ef">i32</span>) {
</span></span><span style="display:flex;"><span>entry:
</span></span><span style="display:flex;"><span>  %temp = <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">i32</span> %0, %1
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">ret</span> <span style="color:#66d9ef">i32</span> %temp
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>Last and the most interesting part - how to run this code?</p>
<p>LLVM C API provides couple of execution engines: <code>MCJIT</code> and <code>Interpreter</code>, we will go with the latter one.</p>
<p><em>Note: To be honest I donâ€™t really know exact difference between them, the only reason I use interpreter here - I got a few different errors when I tried to use MCJIT.</em></p>
<p>Letâ€™s create an execution engine:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> engine = UnsafeMutablePointer&lt;LLVMExecutionEngineRef&gt;.alloc(alignof(LLVMExecutionEngineRef))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> error =  UnsafeMutablePointer&lt;UnsafeMutablePointer&lt;Int8&gt;<span style="color:#f92672">&gt;</span>.alloc(alignof(UnsafeMutablePointer&lt;Int8&gt;))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LLVMLinkInInterpreter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> LLVMCreateInterpreterForModule(engine, module, error) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;can&#39;t initialize engine: </span><span style="color:#e6db74">\(</span>String.fromCString<span style="color:#e6db74">(</span>error.memory<span style="color:#e6db74">)</span><span style="color:#f92672">!</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// </span><span style="color:#75715e">TODO:</span><span style="color:#75715e"> cleanup all allocated memory ;)</span>
</span></span><span style="display:flex;"><span>  exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span></code></pre></div><p>You can build and run it, just to ensure that everything is still working.</p>
<p>Finally, letâ€™s run our function and actually compute the sum. Here we do the same trick as with function type - API requires <code>UnsafeMutablePointer</code>. Keep in mind that you should deallocate this memory manually.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">let</span> x: UInt64 = <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> y: UInt64 = <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> args = [LLVMCreateGenericValueOfInt(int32, x, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            LLVMCreateGenericValueOfInt(int32, y, <span style="color:#ae81ff">1</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> argsRef = UnsafeMutablePointer&lt;LLVMTypeRef&gt;.alloc(args.count)
</span></span><span style="display:flex;"><span>argsRef.initializeFrom(args)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> result = LLVMRunFunction(engine.memory, sumFunction, UInt32(args.count), argsRef)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>x<span style="color:#e6db74">)</span><span style="color:#e6db74"> + </span><span style="color:#e6db74">\(</span>y<span style="color:#e6db74">)</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">\(</span>LLVMGenericValueToInt<span style="color:#e6db74">(</span>result, <span style="color:#ae81ff">0</span><span style="color:#e6db74">))</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>argsRef.dealloc(args.count)
</span></span></code></pre></div><p>If you build and run the program - you will see the result:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-llvm" data-lang="llvm"><span style="display:flex;"><span><span style="color:#75715e">; ModuleID = &#39;Hello&#39;
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">define</span> <span style="color:#66d9ef">i32</span> @sum(<span style="color:#66d9ef">i32</span>, <span style="color:#66d9ef">i32</span>) {
</span></span><span style="display:flex;"><span>entry:
</span></span><span style="display:flex;"><span>  %temp = <span style="color:#66d9ef">add</span> <span style="color:#66d9ef">i32</span> %0, %1
</span></span><span style="display:flex;"><span>  <span style="color:#66d9ef">ret</span> <span style="color:#66d9ef">i32</span> %temp
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">10</span> <span style="color:#960050;background-color:#1e0010">+</span> <span style="color:#ae81ff">25</span> = <span style="color:#ae81ff">35</span>
</span></span></code></pre></div><p>Here is the full code listing:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-swift" data-lang="swift"><span style="display:flex;"><span><span style="color:#66d9ef">import</span> <span style="color:#a6e22e">LLVM_C</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> module = LLVMModuleCreateWithName(<span style="color:#e6db74">&#34;Hello&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> int32 = LLVMInt32Type()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> paramTypes = [int32, int32]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">// need to convert paramTypes into UnsafeMutablePointer because of API requirements</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> paramTypesRef = UnsafeMutablePointer&lt;LLVMTypeRef&gt;.alloc(paramTypes.count)
</span></span><span style="display:flex;"><span>paramTypesRef.initializeFrom(paramTypes)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> returnType = int32
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> functionType = LLVMFunctionType(returnType, paramTypesRef, UInt32(paramTypes.count), <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> sumFunction = LLVMAddFunction(module, <span style="color:#e6db74">&#34;sum&#34;</span>, functionType)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> entryBlock = LLVMAppendBasicBlock(sumFunction, <span style="color:#e6db74">&#34;entry&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> builder = LLVMCreateBuilder()
</span></span><span style="display:flex;"><span>LLVMPositionBuilderAtEnd(builder, entryBlock)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> a = LLVMGetParam(sumFunction, <span style="color:#ae81ff">0</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> b = LLVMGetParam(sumFunction, <span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> temp = LLVMBuildAdd(builder, a, b, <span style="color:#e6db74">&#34;temp&#34;</span>)
</span></span><span style="display:flex;"><span>LLVMBuildRet(builder, temp)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LLVMDumpModule(module)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> engine = UnsafeMutablePointer&lt;LLVMExecutionEngineRef&gt;.alloc(alignof(LLVMExecutionEngineRef))
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> error =  UnsafeMutablePointer&lt;UnsafeMutablePointer&lt;Int8&gt;<span style="color:#f92672">&gt;</span>.alloc(alignof(UnsafeMutablePointer&lt;Int8&gt;))
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>LLVMLinkInInterpreter()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">if</span> LLVMCreateInterpreterForModule(engine, module, error) <span style="color:#f92672">!=</span> <span style="color:#ae81ff">0</span> {
</span></span><span style="display:flex;"><span>  print(<span style="color:#e6db74">&#34;can&#39;t initialize engine: </span><span style="color:#e6db74">\(</span>String.fromCString<span style="color:#e6db74">(</span>error.memory<span style="color:#e6db74">)</span><span style="color:#f92672">!</span><span style="color:#e6db74">)</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>  <span style="color:#75715e">// </span><span style="color:#75715e">TODO:</span><span style="color:#75715e"> cleanup all allocated memory ;)</span>
</span></span><span style="display:flex;"><span>  exit(<span style="color:#ae81ff">1</span>)
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> x: UInt64 = <span style="color:#ae81ff">10</span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> y: UInt64 = <span style="color:#ae81ff">25</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> args = [LLVMCreateGenericValueOfInt(int32, x, <span style="color:#ae81ff">0</span>),
</span></span><span style="display:flex;"><span>            LLVMCreateGenericValueOfInt(int32, y, <span style="color:#ae81ff">1</span>)]
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">var</span> argsRef = UnsafeMutablePointer&lt;LLVMTypeRef&gt;.alloc(args.count)
</span></span><span style="display:flex;"><span>argsRef.initializeFrom(args)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">let</span> result = LLVMRunFunction(engine.memory, sumFunction, UInt32(args.count), argsRef)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>print(<span style="color:#e6db74">&#34;</span><span style="color:#e6db74">\(</span>x<span style="color:#e6db74">)</span><span style="color:#e6db74"> + </span><span style="color:#e6db74">\(</span>y<span style="color:#e6db74">)</span><span style="color:#e6db74"> = </span><span style="color:#e6db74">\(</span>LLVMGenericValueToInt<span style="color:#e6db74">(</span>result, <span style="color:#ae81ff">0</span><span style="color:#e6db74">))</span><span style="color:#e6db74">&#34;</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>argsRef.dealloc(args.count)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>paramTypesRef.dealloc(paramTypes.count)
</span></span><span style="display:flex;"><span>LLVMDisposeModule(module)
</span></span></code></pre></div><h3 id="summary">Summary</h3>
<p>As you may see using LLVM from Swift is a bit tricky, but itâ€™s still doable. It actually gives us great opportunity - you can write a language (probably domain specific) in Swift using all the power of LLVM. C API may look limited, but itâ€™s full enough to start with.</p>
<p>If you curious and want to learn more about the topic, please consider looking at these resources:</p>
<ul>
<li><a href="https://pauladamsmith.com/blog/2015/01/how-to-get-started-with-llvm-c-api.html">How to get started with the LLVM C API</a> - great how-to on LLVM C API. This article basically based on it.</li>
<li><a href="http://llvm.org/docs/tutorial/index.html">Kaleidoscope Tutorials</a> - tutorial on implementing simple but powerful language. Currently, there are two versions - for C++ and OCaml.</li>
<li><a href="https://github.com/bencochran/Kaleidoscope">Kaleidoscope Implementation</a> - same language as above implemented using Swift. Trove of treasures there.</li>
<li><a href="https://github.com/robrix/Auspicion">Auspicion</a> - LLVM C API bindings for Swift.</li>
<li><a href="https://github.com/bencochran/LLVM.swift">LLVM.swift</a> - another Swift wrapper for LLVM C API.</li>
<li><a href="https://github.com/AlexDenisov/swift_llvm">Source code</a> - source code for this article.</li>
</ul>
<p>Thank you for your attention.</p>
<p>Happy hacking!</p>

          </div>
        </article>

        <div>
          <hr />
          <p class="post-page-rfc">
            <a href="mailto:alex@lowlevelbits.org">Drop me a line</a> or ping me on <a
              href="https://twitter.com/1101_debian">twitter</a> if you have questions!
          </p>

          <hr />
          <a href="https://www.buymeacoffee.com/AlexDenisov" target="_blank"><img
              src="https://cdn.buymeacoffee.com/buttons/v2/default-blue.png" alt="Buy Me A Coffee"
              style="height: 40px !important;width: 145px !important;"></a>
        </div>

      </div>

    </div>

    <hr>

<div class="row triple-row">

  <div id="triple-first" class="span4 triple">
    <div class="zone">
  <article class="widget-html-widget widget categories-widget">
    <header>
      <h1>Favorite Categories</h1>
    </header>

    

    
    
    
    

    

    
    
    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    
    
    
    

    

    
    
    
    

    

    
    
    

    <ul>
      
      
      <li>
        <a href="https://lowlevelbits.org/categories/llvm/">llvm (11)</a>
      </li>
      
      
      
      
      
      <li>
        <a href="https://lowlevelbits.org/categories/clang/">clang (4)</a>
      </li>
      
      
      
      
      
      
      
      
      
      
      
      <li>
        <a href="https://lowlevelbits.org/categories/mutation-testing/">mutation testing (2)</a>
      </li>
      
      
      
      <li>
        <a href="https://lowlevelbits.org/categories/systems-programming/">systems programming (2)</a>
      </li>
      
      
      
      <li>
        <a href="https://lowlevelbits.org/categories/reverse-engineering/">reverse engineering (2)</a>
      </li>
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
      
    </ul>
  </article>
</div>
  </div>

  <div id="triple-second" class="span4 triple">
    <div class="zone">
  <article class="widget-html-widget widget recent-posts-widget">

    <header>
      <h1>Recent Posts</h1>
    </header>

    <ul>
      
      
      <li>
        <a href="https://lowlevelbits.org/compiling-ruby.-part-1-cruby-vs-mruby/"> Compiling Ruby. Part 1: CRuby vs mRuby</a>
      </li>
      
      
      
      
      
      <li>
        <a href="https://lowlevelbits.org/how-to-learn-compilers-llvm-edition/"> How to learn compilers: LLVM Edition</a>
      </li>
      
      
      
      <li>
        <a href="https://lowlevelbits.org/llvm-meets-code-property-graphs/"> LLVM meets Code Property Graphs</a>
      </li>
      
      
      
      <li>
        <a href="https://lowlevelbits.org/exploring-llvm-bitcode-interactively/"> Exploring LLVM Bitcode interactively</a>
      </li>
      
      
      
      <li>
        <a href="https://lowlevelbits.org/type-equality-in-llvm/"> Type Equality in LLVM</a>
      </li>
      
      
    </ul>

  </article>
</div>
  </div>

  <div id="triple-third" class="span4 triple">
    

<div class="zone">
  <article class="widget widget-html-widget share-connect-widget">
    <header>
      <h1>Connect</h1>
    </header>
    <ul>
      <li><a href="mailto:alex@lowlevelbits.org" target="_blank">E-Mail</a></li>
      <li><a href="https://mastodon.social/@AlexDenisov" target="_blank">Mastodon</a></li>
      <li><a href="https://twitter.com/1101_debian" target="_blank">Twitter</a></li>
      <li><a href="https://lowlevelbits.org/atom.xml" type="application/rss+xml" target="_blank">RSS</a></li>
      <li><a href="https://lowlevelbits.org/subscribe">Mailing list</a></li>

    </ul>
    
  </article>
</div>
  </div>
</div>

<hr>

<div class="row">
  <div class="copyright span12">Copyright &copy; 2014-2022 - Low Level Bits ðŸ‡ºðŸ‡¦ by Alex Denisov</div>
</div>

  </div> 


  


<script src="https://lowlevelbits.org/js/jquery-1.9.1.js"></script>
<script src="https://lowlevelbits.org/js/bootstrap.js"></script>
<script src="https://lowlevelbits.org/js/tinynav.js"></script>
<script src="https://lowlevelbits.org/js/template.js"></script>
</body>

</html>